---
- name: Create blackbox config
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: blackbox-config
        namespace: "{{ inventory_hostname }}"
        labels:
          app.kubernetes.io/name: "{{ app.name }}"
          app.kubernetes.io/component: blackbox
      data:
        config.yml: |
          modules:
            http_2xx:
              prober: http
              timeout: 5s
              http:
                valid_http_versions: ["HTTP/1.1", "HTTP/2.0"]
                valid_status_codes: []  # Defaults to 2xx
                method: GET
                follow_redirects: true
                fail_if_ssl: false
                fail_if_not_ssl: false
                tls_config:
                  insecure_skip_verify: false
                preferred_ip_protocol: "ip4"
            http_post_2xx:
              prober: http
              timeout: 5s
              http:
                method: POST
                headers:
                  Content-Type: application/json
                body: '{}'
            tcp_connect:
              prober: tcp
              timeout: 5s
            icmp:
              prober: icmp
              timeout: 5s
              icmp:
                preferred_ip_protocol: "ip4"

- name: Create blackbox Deployment
  kubernetes.core.k8s:
    definition:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: "{{ app.name }}-blackbox"
        namespace: "{{ inventory_hostname }}"
        labels:
          app.kubernetes.io/name: "{{ app.name }}"
          app.kubernetes.io/component: blackbox
      spec:
        replicas: 1
        selector:
          matchLabels:
            app.kubernetes.io/name: "{{ app.name }}"
            app.kubernetes.io/component: blackbox
        template:
          metadata:
            labels:
              app.kubernetes.io/name: "{{ app.name }}"
              app.kubernetes.io/component: blackbox
          spec:
            containers:
              - name: blackbox
                image: "{{ registry }}/blackbox:{{ images.blackbox.version }}"
                args:
                  - "--config.file=/etc/blackbox_exporter/config.yml"
                volumeMounts:
                  - name: config
                    mountPath: /etc/blackbox_exporter
                imagePullPolicy: Always
                ports:
                  - containerPort: 9115
                    name: http
                resources:
                  requests:
                    cpu: "{{ resources.blackbox.requests.cpu }}"
                    memory: "{{ resources.blackbox.requests.memory }}"
                  limits:
                    memory: "{{ resources.blackbox.limits.memory }}"
                readinessProbe:
                  httpGet:
                    path: /health
                    port: http
                  initialDelaySeconds: 5
                  periodSeconds: 10
                livenessProbe:
                  httpGet:
                    path: /health
                    port: http
                  initialDelaySeconds: 10
                  periodSeconds: 15
            imagePullSecrets:
              - name: "{{ pull_secret }}"
            volumes:
              - name: config
                configMap:
                  name: blackbox-config

- name: Create blackbox Service
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: Service
      metadata:
        name: "{{ app.name }}-blackbox"
        namespace: "{{ inventory_hostname }}"
        labels:
          app.kubernetes.io/name: "{{ app.name }}"
          app.kubernetes.io/component: blackbox
      spec:
        selector:
          app.kubernetes.io/name: "{{ app.name }}"
          app.kubernetes.io/component: blackbox
        ports:
          - protocol: TCP
            port: 9115
            targetPort: http
            name: http

- name: Create ServiceMonitor for blackbox
  kubernetes.core.k8s:
    definition:
      apiVersion: monitoring.coreos.com/v1
      kind: ServiceMonitor
      metadata:
        name: "{{ app.name }}-blackbox"
        namespace: "{{ inventory_hostname }}"
        labels:
          app.kubernetes.io/name: "{{ app.name }}"
          app.kubernetes.io/component: blackbox
      spec:
        jobLabel: app.kubernetes.io/name
        selector:
          matchLabels:
            app.kubernetes.io/name: "{{ app.name }}"
            app.kubernetes.io/component: blackbox
        endpoints:
          - port: http
            interval: 30s
            scrapeTimeout: 10s
            path: /probe
            params:
              module: ["http_2xx"]
            relabelings:
              # Define the target URL to probe
              - action: replace
                replacement: "{{ app.url }}"
                targetLabel: __param_target
              # Set instance label to the target URL
              - action: replace
                replacement: "{{ app.url }}"
                targetLabel: instance
              - action: replace
                replacement: "{{ app.url }}"
                targetLabel: target_url
              # Define the address of the blackbox exporter
              - action: replace
                replacement: "{{ app.name }}-blackbox.{{ inventory_hostname }}.svc.cluster.local:9115"
                targetLabel: __address__
              # Set job label
              - action: replace
                replacement: "{{ app.name }}-probe"
                targetLabel: job

- name: Create blackbox VPA
  kubernetes.core.k8s:
    definition:
      apiVersion: autoscaling.k8s.io/v1
      kind: VerticalPodAutoscaler
      metadata:
        name: "{{ app.name }}-blackbox-vpa"
        namespace: "{{ inventory_hostname }}"
        labels:
          app.kubernetes.io/name: "{{ app.name }}"
          app.kubernetes.io/component: blackbox
      spec:
        targetRef:
          apiVersion: apps/v1
          kind: Deployment
          name: "{{ app.name }}-blackbox"
        updatePolicy:
          updateMode: "Auto"
        resourcePolicy:
          containerPolicies:
            - containerName: blackbox
              minAllowed:
                cpu: 10m
                memory: 32Mi
              maxAllowed:
                cpu: 200m
                memory: 256Mi

- name: Create blackbox PDB
  kubernetes.core.k8s:
    definition:
      apiVersion: policy/v1
      kind: PodDisruptionBudget
      metadata:
        name: "{{ app.name }}-blackbox-pdb"
        namespace: "{{ inventory_hostname }}"
        labels:
          app.kubernetes.io/name: "{{ app.name }}"
          app.kubernetes.io/component: blackbox
      spec:
        minAvailable: 1
        selector:
          matchLabels:
            app.kubernetes.io/name: "{{ app.name }}"
            app.kubernetes.io/component: blackbox
